#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

- name: Check that TLS prerequisites are satisfied
  ansible.builtin.fail:
    msg: "Cannot setup TLS crypto material for HLFX Loadgen without an organization. Please define it through the 'organization' field."
  when:
    - loadgen_use_tls
    - organization is undefined

- name: Check that a peer role is provided for TLS cert
  ansible.builtin.fail:
    msg: "Cannot setup TLS crypto material for HLFX Loadgen if is not a peer. Please set the field 'organization.role' as 'peer'."
  when:
    - loadgen_use_tls
    - organization is defined
    - (organization.role is undefined) or (organization.role != 'peer')

# =========================
# With cryptogen
# =========================
- name: Transfer the crypto material generated with cryptogen
  ansible.builtin.include_role:
    name: hyperledger.fabricx.loadgen
    tasks_from: crypto/cryptogen/transfer
  when:
    - organization is defined
    - organization.fabric_ca_host is undefined

# =========================
# With Fabric-CA
# =========================
- name: Enroll the Loadgen with Fabric-CA to generate the crypto material
  ansible.builtin.include_role:
    name: hyperledger.fabricx.loadgen
    tasks_from: crypto/fabric_ca/enroll
  when:
    - organization is defined
    - organization.fabric_ca_host is defined
