# hyperledger.fabricx.bin

The role `hyperledger.fabricx.bin` can be used to handle a binary run on a target node.

## Table of Contents <!-- omit in toc -->

- [Prerequisites](#prerequisites)
- [Tasks](#tasks)
  - [go](#go)
    - [build](#build)
    - [multiplatform_build](#multiplatform_build)
    - [install](#install)
    - [multiplatform_install](#multiplatform_install)
  - [transfer](#transfer)
  - [start](#start)
  - [stop](#stop)
  - [rm](#rm)
  - [fetch_logs](#fetch_logs)

## Prerequisites

The role requires:

- `tmux` to run binaries in a tmux session;
- `go` to build/install binaries;
- `rsync` to transfer binaries from the control node to the target node.

## Tasks

### go

The tasks in the [`go`](./tasks/go) section allow to build or install a `go` binary.

#### build

The task `build` allows to build a `go` binary from its source code:

```yaml
- name: Build the sample-go binary
  vars:
    bin_name: sample-go
    bin_source_code_path: /tmp/sample-go/src
    bin_output_dir: /usr/local/bin
    bin_target_os: linux
    bin_target_arch: amd64
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: go/build
```

#### multiplatform_build

The task `multiplatform_build` allows to build a `go` binary for multiple platforms:

```yaml
- name: Build the sample-go binary for multiple platforms
  vars:
    bin_name: sample-go
    bin_source_code_path: /tmp/sample-go/cmd
    bin_service_instances: ["sample-host-amd64", "sample-host-aarch64"]
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: go/multiplatform_build
```

You can set the target platform for an host using the `os` and `arch` variables. For example:

```yaml
sample-host-amd64:
  os: linux
  arch: amd64
sample-host-aarch64:
  os: linux
  arch: aarch64
```

#### install

The task `install` allows to install a go binary with the `go install` paradigm.

```yaml
- name: Install the sample-go binary
  vars:
    bin_go_package: github.com/example/sample-go/cmd
    bin_output_dir: /usr/local/bin
    bin_target_os: linux
    bin_target_arch: amd64
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: go/install
```

#### multiplatform_install

The task `multiplatform_install` allows to install a go binary with the `go install` for multiple platforms.

```yaml
- name: Install the sample-go binary for multiple platforms
  vars:
    bin_go_package: github.com/example/sample-go/cmd
    bin_service_instances: ["sample-host-amd64", "sample-host-aarch64"]
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: go/multiplatform_install
```

### transfer

The task `transfer` allows to transfer a binary from the control node to the remote nodes.

```yaml
- name: Transfer the sample-go binary to the remote hosts
  vars:
    bin_name: sample-go
    bin_output_dir: /usr/local/bin
    bin_remote_dir: /usr/local/bin
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: transfer
```

### start

The task `start` allows to start a binary within a **tmux** session.

```yaml
- name: Start the sample-go binary
  vars:
    bin_name: sample-go
    bin_command: /usr/local/bin/sample-go start
    bin_wait_until_running: true
    bin_wait_port: 9010
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: start
```

### stop

The task `stop` allows to stop a binary by killing the associated **tmux** session.

```yaml
- name: Stop the sample-go binary
  vars:
    bin_name: sample-go
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: stop
```

### rm

The task `rm` allows to remove the binary from the filesystem.

```yaml
- name: Remove the sample-go binary
  vars:
    bin_name: sample-go
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: rm
```

### fetch_logs

The task `fetch_logs` allows to collect the logs generated by a binary.

```yaml
- name: Fetch the logs from the sample-go binary
  vars:
    bin_name: sample-go
    bin_fetched_logs_dir: /tmp/
    bin_fetched_logs_filename: sample-go_logs.txt
  ansible.builtin.include_role:
    name: hyperledger.fabricx.bin
    tasks_from: fetch_logs
```
