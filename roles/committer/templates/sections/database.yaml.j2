# ---------------------------------------------------------------------------
# Database configuration
# Hyperledger Fabric-X Committer supports either PostgresDB or 
# YugabyteDB as persistence layers. YugabyteDB is recommended for 
# high-throughput scenarios.
# ---------------------------------------------------------------------------
database:
  endpoints:
{% if postgres_db_host is defined %}
    # PostgresDB
    - {{ hostvars[postgres_db_host].ansible_host }}:{{ hostvars[postgres_db_host].postgres_port }}
  # The username for the database
  username: {{ hostvars[postgres_db_host].postgres_user }}
  # The password for the database
  password: {{ hostvars[postgres_db_host].postgres_password }}
  # The database name
  database: {{ hostvars[postgres_db_host].postgres_db }}
  # Should be enabled for DB cluster
  load-balance: false
{% if hostvars[postgres_db_host].postgres_use_tls is defined and hostvars[postgres_db_host].postgres_use_tls %}
  # Define TLS certificate for a secure communication with PostgresDB.
  tls:
    # TLS configuration modes ("none", "tls" or "mtls")
    mode: tls
    # DB CA certificate to trust if tls is enabled.    
    ca-cert-path: {{ committer_config_dir }}/tls/db/ca.crt
{% endif %}
{% elif yugabyte_cluster_ref_id is defined %}
{% set yugabyte_cluster = groups['all'] | map('extract', hostvars) | selectattr('yugabyte_cluster_id', 'defined') | selectattr('yugabyte_cluster_id', '==', yugabyte_cluster_ref_id) | map(attribute='inventory_hostname') %}
{% for db in yugabyte_cluster %}
{% if hostvars[db].yugabyte_tablet_pgsql_bind_port is defined %}
    # Yugabyte Tablet
    - {{ hostvars[db].ansible_host }}:{{ hostvars[db].yugabyte_tablet_pgsql_bind_port }}
{% endif %}
{% endfor %}
  # The username for the database
  username: {{ hostvars[yugabyte_cluster | first].yugabyte_user }}
  # The password for the database
  password: {{ hostvars[yugabyte_cluster | first].yugabyte_password }}
  # The database name
  database: {{ hostvars[yugabyte_cluster | first].yugabyte_db }}
  # Should be enabled for DB cluster
  load-balance: true
{% if hostvars[yugabyte_cluster | first].yugabyte_use_tls is defined and hostvars[yugabyte_cluster | first].yugabyte_use_tls %}
  # Define TLS certificate for a secure communication with YugabyteDB.
  tls:
    # TLS configuration modes ("none", "tls" or "mtls")
    mode: tls
    # DB CA certificate to trust if tls is enabled.    
    ca-cert-path: {{ committer_config_dir }}/tls/db/ca.crt
{% endif %}  
{% endif %}
  # The maximum size of the connection pool
  max-connections: {{ committer_database_max_connections | default(10) }}
  # The minimum size of the connection pool
  min-connections: {{ committer_database_min_connections | default(5) }}
  # The exponential backoff retry strategy for database operation.
  retry:
    # This strategy increases the delay between retry attempts exponentially.
    # When using YugabyteDB as the backend, it is needed to handle retryable errors.
    # https://support.yugabyte.com/hc/en-us/articles/4409627048461-How-to-Troubleshoot-Database-Transaction-Retryable-Errors
    # initial-interval: Specifies the duration of the first backoff interval.
    # This is the time to wait before the first retry attempt.
    # Format: string representing a duration (e.g., "500ms", "1s", "2.5s").
    initial-interval: {{ committer_database_retry_initial_interval | default('500ms') }}
    # Controls the amount of randomness (jitter) applied to each backoff interval.
    # The actual backoff duration for an attempt will be randomly selected from the range:
    # [current_interval * (1 - randomization_factor), current_interval * (1 + randomization_factor)]
    # A factor of 0 means no randomization. A factor of 0.5 means the actual interval
    # can vary by +/- 50% of the calculated interval.
    # Must be between 0 and 1.
    randomization-factor: {{ committer_database_retry_randomization_factor | default(0.5) }}
    # The factor by which the backoff interval increases after each failed attempt.
    # The next interval (before randomization) is calculated as: current_interval * multiplier.
    # A value of 1.5 means each subsequent interval will be 50% longer than the previous one.
    # Must be >= 1.
    multiplier: {{ committer_database_retry_multiplier | default(1.5) }}
    # Sets the absolute maximum duration for any single backoff interval.
    # Even if the calculated interval (initial_interval * multiplier^n) exceeds this value,
    # the interval used (before randomization) will be capped at max-interval.
    # Format: string representing a duration (e.g., "60s", "1m", "5m").
    max-interval: {{ committer_database_retry_max_interval | default('60s') }}
    # The maximum total time allowed for retries since the operation first began.
    # If the total time spent (including execution time of attempts and backoff waits)
    # exceeds this duration, the retry mechanism will stop, even if other limits haven't been reached.
    # Setting this to "0" means there is no time limit, and retries will continue
    # indefinitely until successful.
    # Format: string representing a duration (e.g., "15m", "1h").
    max-elapsed-time: {{ committer_database_retry_max_elapsed_time | default('15m') }}
