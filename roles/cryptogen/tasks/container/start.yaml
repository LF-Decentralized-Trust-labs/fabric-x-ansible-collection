#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

# We must clean the folder before because otherwise this
# can create weird effects in the crypto material being
# generated by cryptogen.
- name: Ensure that the cryptogen output folder is clean
  ansible.builtin.file:
    state: absent
    path: "{{ cryptogen_output_dir }}"

- name: Create the cryptogen output folder
  ansible.builtin.file:
    state: directory
    path: "{{ cryptogen_output_dir }}"
    mode: "0o755"

- name: Generate the crypto material with cryptogen as container
  vars:
    container_name: "{{ cryptogen_container_name }}"
    container_image: "{{ cryptogen_image }}"
    container_command: >-
      {{ cryptogen_bin_name }} generate
      --config={{ cryptogen_container_artifacts_dir }}/{{ cryptogen_config_file }}
      --output={{ cryptogen_container_output_dir }}
    container_volumes:
      - "{{ cryptogen_artifacts_dir }}:{{ cryptogen_container_artifacts_dir }}:Z"
      - "{{ cryptogen_output_dir }}:{{ cryptogen_container_output_dir }}:Z"
    container_run_detach_mode: false
    container_run_as_host_user: true
    container_autoremove: true
  ansible.builtin.include_role:
    name: hyperledger.fabricx.container
    tasks_from: start

- name: Find all TLS CA certs
  ansible.builtin.find:
    paths: "{{ cryptogen_output_dir }}"
    patterns: "tlsca*.pem"
    depth: 4
    recurse: true
  register: cryptogen_tlsca_certs

- name: Combine all TLS CA certs in ca-certs.pem
  ansible.builtin.shell: >-
    cat {{ cryptogen_tlsca_certs.files | map(attribute='path') | join(' ') }}
    > {{ cryptogen_output_dir }}/ca-certs.pem
  register: cryptogen_tlscas_result
  changed_when: cryptogen_tlscas_result.rc != 0
  when:
    - cryptogen_tlsca_certs.files | length > 0
