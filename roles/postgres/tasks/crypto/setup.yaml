#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

# =========================
# With OpenSSL
# =========================
- name: Generate the PostgresDB SSL crypto material with OpenSSL
  ansible.builtin.include_role:
    name: hyperledger.fabricx.postgres
    tasks_from: crypto/openssl/generate_cert
  when:
    - postgres_use_tls
    - organization is not defined or (organization is defined and organization.role is undefined)

# =========================
# With cryptogen
# =========================
# If no Fabric CA is defined, assume the crypto material is generated
# with cryptogen. Thus, transfer it.
- name: Transfer the PostgresDB SSL crypto material generated by cryptogen
  ansible.builtin.include_role:
    name: hyperledger.fabricx.postgres
    tasks_from: crypto/cryptogen/transfer
  when:
    - postgres_use_tls
    - organization is defined
    - organization.role is defined
    - organization.role == 'peer'
    - organization.fabric_ca_host is not defined

# =========================
# With Fabric-CA
# =========================
- name: Enroll PostgresDB with Fabric-CA to generate the TLS crypto material
  ansible.builtin.include_role:
    name: hyperledger.fabricx.postgres
    tasks_from: crypto/fabric_ca/enroll
  when:
    - postgres_use_tls
    - organization is defined
    - organization.role is defined
    - organization.role == 'peer'
    - organization.fabric_ca_host is defined

# =========================
# Permissions
# =========================
- name: Set right permissions for TLS private key
  vars:
    container_volume_path: "{{ postgres_remote_config_dir }}/tls/{{ postgres_tls_private_key_file }}"
    container_volume_mode: "0o600"
    container_volume_uid: "999"
    container_volume_gid: "999"
    container_volume_type: file
  ansible.builtin.include_role:
    name: hyperledger.fabricx.container
    tasks_from: volume/create
  when:
    - postgres_use_tls

# This operation is needed for systems where openssl runs with umask=027.
# In this case the certificate will be created with permission 0o640, which
# makes it unreadable from within Postgres (running with user 999).
- name: Set right permissions for Postgres TLS certificate
  ansible.builtin.file:
    path: "{{ postgres_remote_config_dir }}/tls/{{ postgres_tls_cert_file }}"
    mode: "0o644"
  when:
    - postgres_use_tls
