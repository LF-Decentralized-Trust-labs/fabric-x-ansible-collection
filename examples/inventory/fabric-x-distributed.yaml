#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

# This inventory can be used to test the performance of Hyperledger Fabric-X
# by horizontally scaling both the Hyperledger Fabric-X Orderer and Committer
# components.
#
# NOTE: this inventory is NOT ready to use! It points to fake machines named 'linux*amd64.cloud.com'.
# To run this distributed deployment, you need 16 real machines.
#
# This deployment was able to achieve high TPS distributing the components
# over 16 machines with the following properties:
# - RHEL OS;
# - Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz;
# - 64GB RAM;
# - 1000GB SSD disk (to get high-speed IOPS);
#
# To run this inventory:
# 1. install the `hyperledger.fabricx` Ansible collection on your control node;
# 2. target this inventory within `ansible.cfg`;
# 3. set the "Ansible Connection" and "Machines to use" sections to allow a successful connection from the control node to the remote nodes
#    (this requires proper setup of SSH connection between the control node and the remote nodes);
# 4. follow the README to install the prerequisites on all the nodes
# 5. follow the README to run the network.

all:
  vars:
    # =========================
    # Ansible Connection
    # =========================
    ansible_connection: ssh
    ansible_user: root
    ansible_python_interpreter: /usr/bin/python3
    # =========================
    # Machines to use
    # =========================
    os: linux
    arch: amd64
    deploy_dir: /root/perf-deployment # <- point this to your SSD volume mount
    host_machine_1: "linux1amd64.cloud.com" # <- change these machines endpoints to your machines!
    host_machine_2: "linux2amd64.cloud.com"
    host_machine_3: "linux3amd64.cloud.com"
    host_machine_4: "linux4amd64.cloud.com"
    host_machine_5: "linux5amd64.cloud.com"
    host_machine_6: "linux6amd64.cloud.com"
    host_machine_7: "linux7amd64.cloud.com"
    host_machine_8: "linux8amd64.cloud.com"
    host_machine_9: "linux9amd64.cloud.com"
    host_machine_10: "linux10amd64.cloud.com"
    host_machine_11: "linux11amd64.cloud.com"
    host_machine_12: "linux12amd64.cloud.com"
    host_machine_13: "linux13amd64.cloud.com"
    host_machine_14: "linux14amd64.cloud.com"
    host_machine_15: "linux15amd64.cloud.com"
    host_machine_16: "linux16amd64.cloud.com"
    # =========================
    # Control Node paths
    # =========================
    gopath: "{{ lookup('env', 'GOPATH') }}"
    project_dir: "{{ lookup('env', 'PROJECT_DIR') or gopath + '/src/github.ibm.com/decentralized-trust-research/cbdc-platform-deployment' }}"
    out_dir: "{{ lookup('env', 'OUT_DIR') or project_dir + '/out' }}"
    out_log_dir: "{{ out_dir }}/logs"
    out_build_dir: "{{ out_dir }}/build"
    source_code_dir: "{{ out_build_dir }}/code"
    config_build_dir: "{{ out_build_dir }}/config"
    cli_bin_dir: "{{ out_build_dir }}/cli"
    # =========================
    # Remote Node paths
    # =========================
    remote_host_dir: "{{ deploy_dir }}/{{ inventory_hostname }}"
    test_dir: "{{ remote_host_dir }}/test"
    remote_config_dir: "{{ remote_host_dir }}/config"
    # =========================
    # Fabric-X network settings
    # =========================
    topology_name: mytopos
    channel_id: arma
    # =========================
    # Miscellaneous
    # =========================
    node_exporter_port: 9111
    consensus_type: "{{ lookup('env', 'CONSENSUS_TYPE') or 'BFT' }}"
  children:
    network:
      children:
        # =========================
        # Fabric-X hosts
        # =========================
        fabric_x:
          children:
            # =========================
            # Fabric-X Orderers
            # =========================
            # Each Fabric-X Orderer is composed by:
            # - 1 consenter
            # - 1 assembler
            # - 2 batchers
            # - 1 router
            fabric_x_orderers:
              vars:
                organization:
                  name: "OrdererOrg{{ orderer_group }}"
                  domain: "ordererorg{{ orderer_group }}.example.com"
                  role: orderer
              children:
                fabric_x_orderer_1:
                  vars:
                    ansible_host: "{{ host_machine_1 }}"
                    orderer_group: 1
                  hosts:
                    orderer-router-1:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-1-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-1-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-1:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-1:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_2:
                  vars:
                    ansible_host: "{{ host_machine_2 }}"
                    orderer_group: 2
                  hosts:
                    orderer-router-2:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-2-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-2-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-2:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-2:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_3:
                  vars:
                    ansible_host: "{{ host_machine_3 }}"
                    orderer_group: 3
                  hosts:
                    orderer-router-3:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-3-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-3-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-3:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-3:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_4:
                  vars:
                    ansible_host: "{{ host_machine_4 }}"
                    orderer_group: 4
                  hosts:
                    orderer-router-4:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-4-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-4-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-4:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-4:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054

            # =========================
            # Fabric-X Committer
            # =========================
            # The Fabric-X Composed is composed by:
            # - 1 coordinator
            # - 1 sidecar
            # - 7 validators
            # - 7 verifiers
            # - 1 Yugabyte cluster of:
            #   - 3 masters
            #   - 7 tablets
            fabric_x_committer:
              hosts:
                committer-coordinator:
                  committer_component_type: coordinator
                  ansible_host: "{{ host_machine_5 }}"
                  committer_rpc_port: 5300
                  prometheus_exporter_port: 2140
                committer-sidecar:
                  committer_component_type: sidecar
                  ansible_host: "{{ host_machine_6 }}"
                  committer_rpc_port: 5400
                  prometheus_exporter_port: 2150
                committer-query-service:
                  committer_component_type: query-service
                  ansible_host: "{{ host_machine_6 }}"
                  committer_rpc_port: 5500
                  prometheus_exporter_port: 2160
              children:
                committer_validators:
                  vars:
                    committer_component_type: validator
                    committer_rpc_port: 5100
                    prometheus_exporter_port: 2120
                  hosts:
                    committer-validator-1:
                      ansible_host: "{{ host_machine_7 }}"
                    committer-validator-2:
                      ansible_host: "{{ host_machine_8 }}"
                    committer-validator-3:
                      ansible_host: "{{ host_machine_9 }}"
                    committer-validator-4:
                      ansible_host: "{{ host_machine_10 }}"
                    committer-validator-5:
                      ansible_host: "{{ host_machine_11 }}"
                    committer-validator-6:
                      ansible_host: "{{ host_machine_12 }}"
                    committer-validator-7:
                      ansible_host: "{{ host_machine_13 }}"
                committer_verifiers:
                  vars:
                    committer_component_type: verifier
                    committer_rpc_port: 5200
                    prometheus_exporter_port: 2130
                  hosts:
                    committer-verifier-1:
                      ansible_host: "{{ host_machine_7 }}"
                    committer-verifier-2:
                      ansible_host: "{{ host_machine_8 }}"
                    committer-verifier-3:
                      ansible_host: "{{ host_machine_9 }}"
                    committer-verifier-4:
                      ansible_host: "{{ host_machine_10 }}"
                    committer-verifier-5:
                      ansible_host: "{{ host_machine_11 }}"
                    committer-verifier-6:
                      ansible_host: "{{ host_machine_12 }}"
                    committer-verifier-7:
                      ansible_host: "{{ host_machine_13 }}"
                committer_dbs:
                  vars:
                    committer_component_type: db
                    yugabyte_user: yugabyte
                    yugabyte_password: yugabyte
                    yugabyte_db: yugabyte
                  children:
                    yb_masters:
                      vars:
                        yugabyte_component_type: "master"
                        yugabyte_master_rpc_bind_port: 7100
                        yugabyte_master_webserver_port: 7000
                      hosts:
                        yugabytedb-master-1:
                          ansible_host: "{{ host_machine_5 }}"
                        yugabytedb-master-2:
                          ansible_host: "{{ host_machine_6 }}"
                        yugabytedb-master-3:
                          ansible_host: "{{ host_machine_7 }}"
                    yb_tablets:
                      vars:
                        yugabyte_component_type: "tablet"
                        yugabyte_tablet_pgsql_bind_port: 5433
                        yugabyte_tablet_rpc_bind_port: 9100
                        yugabyte_tablet_webserver_port: 9000
                        yugabyte_tablet_redis_web_port: 11001
                        yugabyte_tablet_cql_web_port: 12001
                        yugabyte_tablet_pgsql_web_port: 13001
                      hosts:
                        yugabytedb-tablet-1:
                          ansible_host: "{{ host_machine_7 }}"
                        yugabytedb-tablet-2:
                          ansible_host: "{{ host_machine_8 }}"
                        yugabytedb-tablet-3:
                          ansible_host: "{{ host_machine_9 }}"
                        yugabytedb-tablet-4:
                          ansible_host: "{{ host_machine_10 }}"
                        yugabytedb-tablet-5:
                          ansible_host: "{{ host_machine_11 }}"
                        yugabytedb-tablet-6:
                          ansible_host: "{{ host_machine_12 }}"
                        yugabytedb-tablet-7:
                          ansible_host: "{{ host_machine_13 }}"

    # =========================
    # Fabric-X Loadgen
    # =========================
    # We run 2 load-generators on 2 different machines
    # to generate more load.
    # Once they are up and running, you can increase the
    # load being generated with the command:
    # make load_generators limit-rate LIMIT=<new_limit (e.g. 10000)>
    # Beware that the limit is going to be applied on each loadgen,
    # which means that if you set the limit to LIMIT=10000, the
    # total amount of txs being sent is 10000x2 loadgen=20000 TPS.
    load_generators:
      vars:
        loadgen_type: orderer-client
        prometheus_exporter_port: 2610
        loadgen_web_port: 6997
        loadgen_use_bin: true
        Org1: &Org1
          name: Org1
          domain: org1.example.com
      hosts:
        orderer-loadgen-1:
          ansible_host: "{{ host_machine_14 }}"
          organization:
            <<: *Org1
            users:
              - name: orderer-loadgen
                namespace: 0
                meta_namespace_admin: true
          loadgen_tx_seed: 12345
        orderer-loadgen-2:
          ansible_host: "{{ host_machine_15 }}"
          organization:
            <<: *Org1
            users:
              - name: orderer-loadgen
                namespace: 0
          loadgen_tx_seed: 67890

    # =========================
    # Monitoring
    # =========================
    # Use Prometheus and Grafana to collect
    # metrics from the components and assess the
    # load of txs being sent.
    monitoring:
      vars:
        ansible_host: "{{ host_machine_16 }}"
      hosts:
        grafana:
          grafana_username: admin
          grafana_password: adminPWD
          grafana_web_port: 3000
        prometheus:
          prometheus_web_port: 9090
