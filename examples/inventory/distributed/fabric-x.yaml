#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

# This inventory can be used to test the performance of Hyperledger Fabric-X
# by horizontally scaling both the Hyperledger Fabric-X Orderer and Committer
# components.
#
# NOTE: this inventory is NOT ready to use! It points to fake machines named 'linux*amd64.cloud.com'.
# To run this distributed deployment, you need 16 real machines.
#
# This deployment was able to achieve high TPS distributing the components
# over 16 machines with the following properties:
# - RHEL OS;
# - 2 CPU Sockets each one equipped with Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz;
# - 64GB RAM;
# - 1000GB SSD disk (to get high-speed IOPS);
#
# To run this inventory:
# 1. install the `hyperledger.fabricx` Ansible collection on your control node;
# 2. target this inventory within `ansible.cfg`;
# 3. set the "Ansible Connection" and "Machines to use" sections to allow a successful connection from the control node to the remote nodes
#    (this requires proper setup of SSH connection between the control node and the remote nodes);
# 4. follow the README to install the prerequisites on all the nodes
# 5. follow the README to run the network.

all:
  vars:
    # =========================
    # Organizations
    # =========================
    organizations:
      orderer_org_1: &OrdererOrg1
        name: OrdererOrg1
        domain: ordererorg1.example.com
      orderer_org_2: &OrdererOrg2
        name: OrdererOrg2
        domain: ordererorg2.example.com
      orderer_org_3: &OrdererOrg3
        name: OrdererOrg3
        domain: ordererorg3.example.com
      orderer_org_4: &OrdererOrg4
        name: OrdererOrg4
        domain: ordererorg4.example.com
      org1: &Org1
        name: Org1
        domain: org1.example.com
  children:
    # =========================
    # Network (HLFX)
    # =========================
    network:
      children:
        # =========================
        # Hyperledger Fabric-X
        # =========================
        fabric_x:
          children:
            # =========================
            # HLFX Orderers
            # =========================
            fabric_x_orderers:
              vars:
                orderer_use_tls: true
                orderer_use_mtls: true
              children:
                fabric_x_orderer_1:
                  vars:
                    organization:
                      <<: *OrdererOrg1
                      role: orderer
                    ansible_host: "{{ host_machine_1 }}"
                    orderer_group: 1
                  hosts:
                    orderer-router-1:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-1-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-1-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-1:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-1:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_2:
                  vars:
                    organization:
                      <<: *OrdererOrg2
                      role: orderer
                    ansible_host: "{{ host_machine_2 }}"
                    orderer_group: 2
                  hosts:
                    orderer-router-2:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-2-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-2-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-2:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-2:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_3:
                  vars:
                    organization:
                      <<: *OrdererOrg3
                      role: orderer
                    ansible_host: "{{ host_machine_3 }}"
                    orderer_group: 3
                  hosts:
                    orderer-router-3:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-3-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-3-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-3:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-3:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054
                fabric_x_orderer_4:
                  vars:
                    organization:
                      <<: *OrdererOrg4
                      role: orderer
                    ansible_host: "{{ host_machine_4 }}"
                    orderer_group: 4
                  hosts:
                    orderer-router-4:
                      orderer_component_type: router
                      orderer_rpc_port: 7050
                    orderer-batcher-4-1:
                      orderer_shard_id: 1
                      orderer_component_type: batcher
                      orderer_rpc_port: 7051
                    orderer-batcher-4-2:
                      orderer_shard_id: 2
                      orderer_component_type: batcher
                      orderer_rpc_port: 7052
                    orderer-consenter-4:
                      orderer_component_type: consenter
                      orderer_rpc_port: 7053
                    orderer-assembler-4:
                      orderer_component_type: assembler
                      orderer_rpc_port: 7054

            # =========================
            # HLFX Committer
            # =========================
            fabric_x_committer:
              vars:
                committer_use_tls: true
                committer_use_mtls: true
                organization:
                  <<: *Org1
                  role: peer
              hosts:
                committer-sidecar:
                  committer_component_type: sidecar
                  ansible_host: "{{ host_machine_5 }}"
                  committer_rpc_port: 5400
                  prometheus_exporter_port: 2150
                committer-coordinator:
                  committer_component_type: coordinator
                  ansible_host: "{{ host_machine_6 }}"
                  committer_rpc_port: 5300
                  prometheus_exporter_port: 2140
                committer-query-service:
                  committer_component_type: query-service
                  ansible_host: "{{ host_machine_6 }}"
                  yugabyte_cluster_ref_id: 1
                  committer_rpc_port: 5500
                  prometheus_exporter_port: 2160
              children:
                committer_validators:
                  vars:
                    committer_component_type: validator
                    committer_rpc_port: 5100
                    prometheus_exporter_port: 2120
                    yugabyte_cluster_ref_id: 1
                  hosts:
                    committer-validator-1:
                      ansible_host: "{{ host_machine_7 }}"
                    committer-validator-2:
                      ansible_host: "{{ host_machine_8 }}"
                    committer-validator-3:
                      ansible_host: "{{ host_machine_9 }}"
                    committer-validator-4:
                      ansible_host: "{{ host_machine_10 }}"
                    committer-validator-5:
                      ansible_host: "{{ host_machine_11 }}"
                    committer-validator-6:
                      ansible_host: "{{ host_machine_12 }}"
                    committer-validator-7:
                      ansible_host: "{{ host_machine_13 }}"
                committer_verifiers:
                  vars:
                    committer_component_type: verifier
                    committer_rpc_port: 5200
                    prometheus_exporter_port: 2130
                  hosts:
                    committer-verifier-1:
                      ansible_host: "{{ host_machine_7 }}"
                    committer-verifier-2:
                      ansible_host: "{{ host_machine_8 }}"
                    committer-verifier-3:
                      ansible_host: "{{ host_machine_9 }}"
                    committer-verifier-4:
                      ansible_host: "{{ host_machine_10 }}"
                    committer-verifier-5:
                      ansible_host: "{{ host_machine_11 }}"
                    committer-verifier-6:
                      ansible_host: "{{ host_machine_12 }}"
                    committer-verifier-7:
                      ansible_host: "{{ host_machine_13 }}"
                committer_dbs:
                  vars:
                    yugabyte_user: yugabyte
                    yugabyte_password: yugabyte
                    yugabyte_db: yugabyte
                    yugabyte_cluster_id: 1
                    yugabyte_use_tls: true
                  children:
                    yb_masters:
                      vars:
                        yugabyte_component_type: master
                        yugabyte_master_rpc_bind_port: 7100
                        yugabyte_master_webserver_port: 7000
                      hosts:
                        yugabytedb-master-1:
                          ansible_host: "{{ host_machine_5 }}"
                        yugabytedb-master-2:
                          ansible_host: "{{ host_machine_6 }}"
                        yugabytedb-master-3:
                          ansible_host: "{{ host_machine_7 }}"
                    yb_tablets:
                      vars:
                        yugabyte_component_type: tablet
                        yugabyte_tablet_pgsql_bind_port: 5433
                        yugabyte_tablet_rpc_bind_port: 9100
                        yugabyte_tablet_webserver_port: 9000
                        yugabyte_tablet_redis_web_port: 11001
                        yugabyte_tablet_cql_web_port: 12001
                        yugabyte_tablet_pgsql_web_port: 13001
                      hosts:
                        yugabytedb-tablet-1:
                          ansible_host: "{{ host_machine_7 }}"
                        yugabytedb-tablet-2:
                          ansible_host: "{{ host_machine_8 }}"
                        yugabytedb-tablet-3:
                          ansible_host: "{{ host_machine_9 }}"
                        yugabytedb-tablet-4:
                          ansible_host: "{{ host_machine_10 }}"
                        yugabytedb-tablet-5:
                          ansible_host: "{{ host_machine_11 }}"
                        yugabytedb-tablet-6:
                          ansible_host: "{{ host_machine_12 }}"
                        yugabytedb-tablet-7:
                          ansible_host: "{{ host_machine_13 }}"

    # =========================
    # HLFX LoadGens
    # =========================
    # We run 2 load-generators on 2 different machines
    # to generate more load.
    # Once they are up and running, you can increase the
    # load being generated with the command:
    # make load_generators limit-rate LIMIT=<new_limit (e.g. 10000)>
    # Beware that the limit is going to be applied on each loadgen,
    # which means that if you set the limit to LIMIT=10000, the
    # total amount of txs being sent is 10000x2 loadgen=20000 TPS.
    load_generators:
      vars:
        loadgen_type: orderer-client
        prometheus_exporter_port: 2610
        loadgen_web_port: 6997
        loadgen_use_tls: true
      hosts:
        orderer-loadgen-1:
          ansible_host: "{{ host_machine_14 }}"
          organization:
            <<: *Org1
            role: peer
            users:
              - name: orderer-loadgen
                namespace: 0
                meta_namespace_admin: true
          loadgen_tx_seed: 12345
        orderer-loadgen-2:
          ansible_host: "{{ host_machine_15 }}"
          organization:
            <<: *Org1
            role: peer
            users:
              - name: orderer-loadgen
                namespace: 0
          loadgen_tx_seed: 67890

    # =========================
    # Monitoring Infra
    # =========================
    monitoring:
      vars:
        ansible_host: "{{ host_machine_16 }}"
      children:
        node_exporters:
          vars:
            node_exporter_port: 9111
            node_exporter_use_tls: true
          hosts:
            node-exporter-1:
              ansible_host: "{{ host_machine_1 }}"
            node-exporter-2:
              ansible_host: "{{ host_machine_2 }}"
            node-exporter-3:
              ansible_host: "{{ host_machine_3 }}"
            node-exporter-4:
              ansible_host: "{{ host_machine_4 }}"
            node-exporter-5:
              ansible_host: "{{ host_machine_5 }}"
            node-exporter-6:
              ansible_host: "{{ host_machine_6 }}"
            node-exporter-7:
              ansible_host: "{{ host_machine_7 }}"
            node-exporter-8:
              ansible_host: "{{ host_machine_8 }}"
            node-exporter-9:
              ansible_host: "{{ host_machine_9 }}"
            node-exporter-10:
              ansible_host: "{{ host_machine_10 }}"
            node-exporter-11:
              ansible_host: "{{ host_machine_11 }}"
            node-exporter-12:
              ansible_host: "{{ host_machine_12 }}"
            node-exporter-13:
              ansible_host: "{{ host_machine_13 }}"
            node-exporter-14:
              ansible_host: "{{ host_machine_14 }}"
            node-exporter-15:
              ansible_host: "{{ host_machine_15 }}"
            node-exporter-16:
              ansible_host: "{{ host_machine_16 }}"
      hosts:
        prometheus:
          prometheus_port: 9090
          prometheus_use_tls: true
        grafana:
          grafana_username: admin
          grafana_password: adminPWD
          grafana_web_port: 3000
          prometheus_host: prometheus
          grafana_use_tls: true
