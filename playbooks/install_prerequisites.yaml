#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

- name: Create list of machines to setup
  hosts: "{{ target_hosts | default('all') }}"
  tasks:
    - name: Select machines to setup
      vars:
        hostname_per_machine: >-
          {{
            ansible_play_hosts
            | map('extract', hostvars)
            | selectattr('ansible_host', '==', item)
            | map(attribute='inventory_hostname') | sort
            | first
          }}
      ansible.builtin.add_host:
        name: "{{ hostname_per_machine }}"
        groups: machines
      loop: >-
        {{
          ansible_play_hosts
          | map('extract', hostvars, 'ansible_host')
          | unique
          | list
        }}

- name: Install prerequisites
  hosts: "{{ target_hosts | default('machines') }}:&machines"
  tasks:
    - name: Install the container engine
      ansible.builtin.include_role:
        name: hyperledger.fabricx.container
        tasks_from: install
    - name: Install tmux
      ansible.builtin.include_role:
        name: hyperledger.fabricx.tmux
        tasks_from: install
    - name: Install openssl
      ansible.builtin.include_role:
        name: hyperledger.fabricx.openssl
        tasks_from: install
    - name: Install rsync
      vars:
        package_name: rsync
      ansible.builtin.include_role:
        name: hyperledger.fabricx.package
        tasks_from: install
    - name: Install chrony on Linux
      vars:
        package_name: chrony
        package_has_service: true
      ansible.builtin.include_role:
        name: hyperledger.fabricx.package
        tasks_from: install
      when:
        - ansible_facts.system == 'Linux'
    - name: Install chronyc on macOS
      vars:
        package_name: chronyc
      ansible.builtin.include_role:
        name: hyperledger.fabricx.package
        tasks_from: install
      when:
        - ansible_facts.system == 'Darwin'
