#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

- name: Create the genesis block
  hosts: localhost
  tasks:
    - name: Create the configuration file for armageddon
      vars:
        armageddon_orderer_hosts: "{{ groups['fabric-x-orderers'] }}"
      ansible.builtin.include_role:
        name: hyperledger.fabricx.armageddon
        tasks_from: config/build
      when: "'fabric-x-orderers' in groups"
    - name: Generate shared_config.binpb
      ansible.builtin.include_role:
        name: hyperledger.fabricx.armageddon
        tasks_from: create_shared_config
      when: "'fabric-x-orderers' in groups"
    - name: Group orderers by organization
      vars:
        org_domain: "{{ hostvars[orderer].organization.domain }}"
        org_name: "{{ hostvars[orderer].organization.name }}"
        orderer_info:
          name: "{{ orderer }}"
      ansible.builtin.set_fact:
        configtxgen_orderers_by_org: >-
          {{
            configtxgen_orderers_by_org | default({}) | combine({
              org_domain: {
                'name': org_name,
                'domain': org_domain,
                'orderers': (
                  (configtxgen_orderers_by_org | default({})).get(org_domain, {}).get('orderers', []) + [orderer_info]
                )
              }
            })
          }}
      loop: >-
        {{
          groups['fabric-x-orderers']
          | default([])
          | map('extract', hostvars)
          | selectattr('organization', 'defined')
          | selectattr('organization.role', 'defined')
          | selectattr('organization.role', '==', 'orderer')
          | map(attribute='inventory_hostname')
        }}
      loop_control:
        loop_var: orderer
    - name: Group peers by organization
      vars:
        org_domain: "{{ hostvars[peer].organization.domain }}"
        org_name: "{{ hostvars[peer].organization.name }}"
        peer_info:
          name: "{{ peer }}"
      ansible.builtin.set_fact:
        configtxgen_peers_by_org: >-
          {{
            configtxgen_peers_by_org | default({}) | combine({
              org_domain: {
                'name': org_name,
                'domain': org_domain,
                'peers': (
                  (configtxgen_peers_by_org | default({})).get(org_domain, {}).get('peers', []) + [peer_info]
                )
              }
            })
          }}
      loop: >-
        {{
          groups['all']
          | map('extract', hostvars)
          | selectattr('organization', 'defined')
          | selectattr('organization.role', 'defined')
          | selectattr('organization.role', '==', 'peer')
          | map(attribute='inventory_hostname')
        }}
      loop_control:
        loop_var: peer
    - name: Check that at most one namespace admin user is defined
      vars:
        namespace_admin_users: >-
          {{
            groups['all']
            | map('extract', hostvars)
            | selectattr('organization', 'defined')
            | selectattr('organization.users', 'defined')
            | map(attribute='organization.users')
            | flatten
            | selectattr('meta_namespace_admin', 'defined')
            | selectattr('meta_namespace_admin', '==', true)
            | list
          }}
      ansible.builtin.fail:
        msg: "More than one Admin user for the MetaNamespace defined: {{ namespace_admin_users }}. Only 1 admin is allowed for the MetaNamespace."
      when:
        - namespace_admin_users | length > 1
    - name: Set the Hyperledger Fabric-X meta namespace admin user
      vars:
        current_organization: "{{ org_user[0] }}"
        user: "{{ org_user[1] }}"
      ansible.builtin.set_fact:
        configtxgen_meta_namespace_admin:
          name: "{{ user.name }}"
          organization:
            name: "{{ current_organization.name }}"
            domain: "{{ current_organization.domain }}"
      with_subelements:
        - >-
          {{
            groups['all']
            | map('extract', hostvars)
            | selectattr('organization', 'defined')
            | map(attribute='organization')
            | selectattr('users', 'defined')
          }}
        - "users"
      loop_control:
        label: "{{ current_organization.domain }}:{{ user.name }}"
        loop_var: org_user
      when:
        - user.meta_namespace_admin is defined
        - user.meta_namespace_admin
    - name: Build Fabricx-compatible configuration file for configtxgen
      ansible.builtin.include_role:
        name: hyperledger.fabricx.configtxgen
        tasks_from: config/build
    - name: Install configtxgen as binary for Fabric-X
      ansible.builtin.include_role:
        name: hyperledger.fabricx.configtxgen
        tasks_from: bin/install
      when:
        - configtxgen_use_bin is defined
        - configtxgen_use_bin
    - name: Generate the genesis block for Fabric-X
      ansible.builtin.include_role:
        name: hyperledger.fabricx.configtxgen
        tasks_from: start
